!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var o;"undefined"!=typeof window?o=window:"undefined"!=typeof global?o=global:"undefined"!=typeof self&&(o=self),o.resourceShadow=e()}}(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
(function(e){var r=require("./resource-shadow");if(exports.ResourceShadow=r,exports.create=r.create,e.browser)exports.version="0.0.4",exports.homepage="https://github.com/benjamine/resource-shadow";else{var o=require("../package.json");exports.version=o.version,exports.homepage=o.homepage}}).call(this,require("_process"));
},{"../package.json":4,"./resource-shadow":7,"_process":2}],2:[function(require,module,exports){
function noop(){}var process=module.exports={};process.nextTick=function(){var o="undefined"!=typeof window&&window.setImmediate,e="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(o)return function(o){return window.setImmediate(o)};if(e){var s=[];return window.addEventListener("message",function(o){var e=o.source;if((e===window||null===e)&&"process-tick"===o.data&&(o.stopPropagation(),s.length>0)){var n=s.shift();n()}},!0),function(o){s.push(o),window.postMessage("process-tick","*")}}return function(o){setTimeout(o,0)}}(),process.title="browser",process.browser=!0,process.env={},process.argv=[],process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.binding=function(){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(){throw new Error("process.chdir is not supported")};
},{}],3:[function(require,module,exports){
function M(){this._events={}}M.prototype={on:function(t,e){this._events||(this._events={});var n=this._events;return(n[t]||(n[t]=[])).push(e),this},removeListener:function(t,e){var n,s=this._events[t]||[];for(n=s.length-1;n>=0&&s[n];n--)(s[n]===e||s[n].cb===e)&&s.splice(n,1)},removeAllListeners:function(t){t?this._events[t]&&(this._events[t]=[]):this._events={}},emit:function(t){this._events||(this._events={});var e,n=Array.prototype.slice.call(arguments,1),s=this._events[t]||[];for(e=s.length-1;e>=0&&s[e];e--)s[e].apply(this,n);return this},when:function(t,e){return this.once(t,e,!0)},once:function(t,e,n){function s(){n||this.removeListener(t,s),e.apply(this,arguments)&&n&&this.removeListener(t,s)}return e?(s.cb=e,this.on(t,s),this):this}},M.mixin=function(t){var e,n=M.prototype;for(e in n)n.hasOwnProperty(e)&&(t.prototype[e]=n[e])},module.exports=M;
},{}],4:[function(require,module,exports){
module.exports={
  "name": "resource-shadow",
  "version": "0.0.4",
  "description": "",
  "main": "./src/main",
  "scripts": {
    "test": "gulp test && gulp test-browser",
    "bump": "gulp bump",
    "cover": "istanbul cover --root src gulp test",
    "cover-report": "open coverage/lcov-report/index.html",
    "cover-publish": "istanbul cover _mocha --report lcovonly && codeclimate < coverage/lcov.info"
  },
  "author": "Benjamin Eidelman <beneidel@gmail.com>",
  "homepage": "https://github.com/benjamine/resource-shadow",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/benjamine/resource-shadow.git"
  },
  "devDependencies": {
    "bulk-require": "^0.2.1",
    "codeclimate-test-reporter": "0.0.3",
    "expect.js": "~0.3.1",
    "fiberglass": "~0.0.11",
    "gulp": "^3.8.8",
    "istanbul": "^0.3.2",
    "mocha": "^2.0.1"
  },
  "testling": {
    "harness": "mocha",
    "files": "test/index.js",
    "scripts": [
      "build/resource-shadow.js"
    ],
    "browsers": [
      "ie/8..latest",
      "chrome/27..latest",
      "firefox/22..latest",
      "safari/5.1..latest",
      "opera/12..latest",
      "iphone/6..latest",
      "ipad/6..latest",
      "android-browser/4.2..latest"
    ]
  },
  "dependencies": {
    "microee": "0.0.5"
  }
}

},{}],5:[function(require,module,exports){
function HttpHandler(){}HttpHandler.prototype.ajax=function(t,e,n,r,a){var o=new XMLHttpRequest;if(o.open(t,e,!0),r&&o.setRequestHeader("Content-Type","application/json; charset=UTF-8"),n)for(var s in n)o.setRequestHeader(s,n[s]);var p,u=!1;o.onload=function(){if(!u)if(u=!0,o.status>=200&&o.status<400)p=o.responseText,a(null,p);else{var t=new Error("http error "+o.status);t.status=o.status,a(t)}},o.onerror=function(t){u||(u=!0,a(t))},r?o.send(r):o.send()},HttpHandler.prototype.get=function(t,e,n){return this.ajax("GET",t,e,null,n)},HttpHandler.prototype.put=function(t,e,n,r){return this.ajax("PUT",t,e,n,r)},module.exports=new HttpHandler;
},{}],6:[function(require,module,exports){
(function(n){function t(){}function e(n,t,e){n.addEventListener?n.addEventListener(t,e,!1):n.attachEvent&&n.attachEvent("on"+t,function(){e.apply(n,arguments)})}t.prototype.onKeyChange=function(t,o){n.browser&&e(window,"storage",function(n){n.key===t&&o()})},module.exports=new t}).call(this,require("_process"));
},{"_process":2}],7:[function(require,module,exports){
function ResourceShadow(t){this.data={},this.localKey=t.localKey,this.url=t.url,this.options=t,this.localStorage=t.localStorage||localStorage,this.localStorageObserver=t.localStorageObserver||(defaultLocalStorageObserver=defaultLocalStorageObserver||require("./local-storage-observer")),this.httpHandler=t.httpHandler||(defaultHttpHandler=defaultHttpHandler||require("./http-handler")),this.load(),this.localStorageObserver&&this.listenForStorageEvent()}var microee=require("microee"),defaultHttpHandler,defaultLocalStorageObserver;microee.mixin(ResourceShadow),ResourceShadow.create=function(t){return new ResourceShadow(t)},ResourceShadow.prototype.apply=function(t){this.beforeApply();try{"object"==typeof t?this.mirrorObject(t,this.data):t.call(this,this.data)}finally{return this.afterApply(),this}},ResourceShadow.prototype.beforeApply=function(){this.mirrorObject(this.getLocalStorageValue(),this.data)},ResourceShadow.prototype.afterApply=function(){this.setLocalStorageValue(this.data),this.save(),this.onChange()},ResourceShadow.prototype.save=function(){if(!this.loading&&!this.saving){if(this.saveRequested=!1,!this.url)return void this.onSaved();var t=this.localStorage.getItem(this.localKey);if(this.shadow!==t){this.saving=!0;var e=this;this.httpHandler.put(this.url,this.httpHeaders(),t,function(o,r){return e.saving=!1,o?void e.onSaveError(o):(e.onSaved(),void e.processJsonFromServer(r,t))})}else this.onSaved()}},ResourceShadow.prototype.loadAndRebase=function(){return this.load({})},ResourceShadow.prototype.loadLocal=function(){var t=this.stringify(this.data);this.localStorage.getItem(this.localKey)!==t&&(this.mirrorObject(this.getLocalStorageValue(),this.data),this.onChange())},ResourceShadow.prototype.load=function(t){if(this.loadLocal(),this.loading||this.saving)return this;if(!this.url)return this.onLoaded(),this;var e;t?(e=t,"string"!=typeof e&&(e=this.stringify(e))):e=this.localStorage.getItem(this.localKey),this.loading=!0;var o=this;return this.httpHandler.get(this.url,this.httpHeaders(),function(r,a){return o.loading=!1,r?(r.loadArguments=[t],void o.onLoadError(r)):(o.processJsonFromServer(a,e),void o.onLoaded())}),this},ResourceShadow.prototype.processJsonFromServer=function(t,e){this.shadow=t;var o=this.localStorage.getItem(this.localKey);if(t!==e){var r=!1;e!==o&&(t=this.threeWayMerge(e,t,o),"object"==typeof t&&(t=this.stringify(t)),r=t!==this.shadow);var a;try{a=this.parse(t)}catch(i){a=null}"object"==typeof a&&this.mirrorObject(a,this.data),this.setLocalStorageValue(this.data),this.onChange(),r&&this.save()}else e!==o&&this.save()},ResourceShadow.prototype.listenForStorageEvent=function(){if(!this.listeningForStorageEvent&&this.localStorageObserver){var t=this;this.localStorageObserver.onKeyChange(this.localKey,function(){this.settingLocalStorage||t.loadLocal()}),this.listeningForStorageEvent=!0}},ResourceShadow.prototype.mirrorObject=function(t,e){function o(t,e,o){var a=t[o],i=e[o];return"undefined"!=typeof i&&"object"==typeof a&&"object"==typeof i&&a instanceof Array==i instanceof Array?void r.mirrorObject(a,i):void(e[o]=a)}var r=this;if("object"==typeof t&&"object"==typeof e){if(t instanceof Array&&e instanceof Array){for(var a=t.length,i=0;a>i;i++)o(t,e,i);return void(e.length=t.length)}for(var s in t)o(t,e,s);for(s in e)"undefined"==typeof t[s]&&delete e[s]}},ResourceShadow.prototype.threeWayMerge=function(t,e,o){return this.options.threeWayMerge?this.options.threeWayMerge.call(this,t,e,o):o},ResourceShadow.prototype.parse=function(t){return JSON.parse(t)},ResourceShadow.prototype.stringify=function(t){return JSON.stringify(t)},ResourceShadow.prototype.httpHeaders=function(){return this.options.headers},ResourceShadow.prototype.onChange=function(){this.emit("change",this.data)},ResourceShadow.prototype.onSaved=function(){this.emit("saved")},ResourceShadow.prototype.onLoaded=function(){this.emit("loaded")},ResourceShadow.prototype.shouldRetry=function(t){return this.options.retry===!1?!1:t.status&&[408,409,410,419,420,429,500,502,503,504,509,521,522,524,598,599].indexOf(t.status)<0?!1:!0},ResourceShadow.prototype.onSaveError=function(t){var e=this;this.shouldRetry(t)&&setTimeout(function(){e.save()},this.options.retryDelay||5e3),this.emit("saveerror",t)},ResourceShadow.prototype.onLoadError=function(t){var e=this;this.shouldRetry(t)&&setTimeout(function(){e.load.apply(e,t.loadArguments)},this.options.retryDelay||5e3),this.emit("loaderror",t)},ResourceShadow.prototype.setUrl=function(t,e){return this.url=t,e&&(this.options.headers=e),this},ResourceShadow.prototype.getLocalStorageValue=function(){var t=this.localStorage.getItem(this.localKey);if(null===t||"undefined"==typeof t||""===t)return{};try{return this.parse(t)||{}}catch(e){return{}}},ResourceShadow.prototype.setLocalStorageValue=function(t){var e;if(null===t||"undefined"==typeof t)e=null;else try{e=this.stringify(t)}catch(o){e=null}var r=this.localStorage.getItem(this.localKey);this.settingLocalStorage=!0;try{r!==e&&(null===e?this.localStorage.removeItem(this.localKey):this.localStorage.setItem(this.localKey,e))}finally{this.settingLocalStorage=!1}return e},module.exports=ResourceShadow;
},{"./http-handler":5,"./local-storage-observer":6,"microee":3}]},{},[1])(1)
});


//# sourceMappingURL=resource-shadow.min.map