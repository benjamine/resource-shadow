!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var o;"undefined"!=typeof window?o=window:"undefined"!=typeof global?o=global:"undefined"!=typeof self&&(o=self),o.resourceShadow=e()}}(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
(function(e){var r=require("./resource-shadow");if(exports.ResourceShadow=r,exports.create=r.create,e.browser)exports.version="0.0.8",exports.homepage="https://github.com/benjamine/resource-shadow";else{var o=require("../package.json");exports.version=o.version,exports.homepage=o.homepage}}).call(this,require("_process"));
},{"../package.json":4,"./resource-shadow":7,"_process":2}],2:[function(require,module,exports){
function noop(){}var process=module.exports={};process.nextTick=function(){var o="undefined"!=typeof window&&window.setImmediate,e="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(o)return function(o){return window.setImmediate(o)};if(e){var s=[];return window.addEventListener("message",function(o){var e=o.source;if((e===window||null===e)&&"process-tick"===o.data&&(o.stopPropagation(),s.length>0)){var n=s.shift();n()}},!0),function(o){s.push(o),window.postMessage("process-tick","*")}}return function(o){setTimeout(o,0)}}(),process.title="browser",process.browser=!0,process.env={},process.argv=[],process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.binding=function(){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(){throw new Error("process.chdir is not supported")};
},{}],3:[function(require,module,exports){
function M(){this._events={}}M.prototype={on:function(t,e){this._events||(this._events={});var n=this._events;return(n[t]||(n[t]=[])).push(e),this},removeListener:function(t,e){var n,s=this._events[t]||[];for(n=s.length-1;n>=0&&s[n];n--)(s[n]===e||s[n].cb===e)&&s.splice(n,1)},removeAllListeners:function(t){t?this._events[t]&&(this._events[t]=[]):this._events={}},emit:function(t){this._events||(this._events={});var e,n=Array.prototype.slice.call(arguments,1),s=this._events[t]||[];for(e=s.length-1;e>=0&&s[e];e--)s[e].apply(this,n);return this},when:function(t,e){return this.once(t,e,!0)},once:function(t,e,n){function s(){n||this.removeListener(t,s),e.apply(this,arguments)&&n&&this.removeListener(t,s)}return e?(s.cb=e,this.on(t,s),this):this}},M.mixin=function(t){var e,n=M.prototype;for(e in n)n.hasOwnProperty(e)&&(t.prototype[e]=n[e])},module.exports=M;
},{}],4:[function(require,module,exports){
module.exports={
  "name": "resource-shadow",
  "version": "0.0.8",
  "description": "",
  "main": "./src/main",
  "scripts": {
    "test": "gulp test && gulp test-browser",
    "bump": "gulp bump",
    "cover": "istanbul cover --root src gulp test",
    "cover-report": "open coverage/lcov-report/index.html",
    "cover-publish": "istanbul cover _mocha --report lcovonly && codeclimate < coverage/lcov.info"
  },
  "author": "Benjamin Eidelman <beneidel@gmail.com>",
  "homepage": "https://github.com/benjamine/resource-shadow",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/benjamine/resource-shadow.git"
  },
  "devDependencies": {
    "bulk-require": "^0.2.1",
    "codeclimate-test-reporter": "0.0.3",
    "expect.js": "~0.3.1",
    "fiberglass": "~0.0.11",
    "gulp": "^3.8.8",
    "istanbul": "^0.3.2",
    "mocha": "^2.0.1"
  },
  "testling": {
    "harness": "mocha",
    "files": "test/index.js",
    "scripts": [
      "build/resource-shadow.js"
    ],
    "browsers": [
      "ie/8..latest",
      "chrome/27..latest",
      "firefox/22..latest",
      "safari/5.1..latest",
      "opera/12..latest",
      "iphone/6..latest",
      "ipad/6..latest",
      "android-browser/4.2..latest"
    ]
  },
  "dependencies": {
    "microee": "0.0.5"
  }
}

},{}],5:[function(require,module,exports){
function HttpHandler(){}HttpHandler.prototype.ajax=function(t,e,n,r,a){var o=new XMLHttpRequest;if(o.open(t,e,!0),r&&o.setRequestHeader("Content-Type","application/json; charset=UTF-8"),n)for(var s in n)o.setRequestHeader(s,n[s]);var p,u=!1;o.onload=function(){if(!u)if(u=!0,o.status>=200&&o.status<400)p=o.responseText,a(null,p);else{var t=new Error("http error "+o.status);t.status=o.status,a(t)}},o.onerror=function(t){u||(u=!0,a(t))},r?o.send(r):o.send()},HttpHandler.prototype.get=function(t,e,n){return this.ajax("GET",t,e,null,n)},HttpHandler.prototype.put=function(t,e,n,r){return this.ajax("PUT",t,e,n,r)},module.exports=new HttpHandler;
},{}],6:[function(require,module,exports){
(function(n){function t(){}function e(n,t,e){n.addEventListener?n.addEventListener(t,e,!1):n.attachEvent&&n.attachEvent("on"+t,function(){e.apply(n,arguments)})}t.prototype.onKeyChange=function(t,o){n.browser&&e(window,"storage",function(n){n.key===t&&o()})},module.exports=new t}).call(this,require("_process"));
},{"_process":2}],7:[function(require,module,exports){
function ResourceShadow(e){this.data={},this.localKey=e.localKey,this.url=e.url,this.options=e,this.online=e.online===!0||!!e.url&&e.online!==!1,this.localStorage=e.localStorage||localStorage,this.localStorageObserver=e.localStorageObserver||(defaultLocalStorageObserver=defaultLocalStorageObserver||require("./local-storage-observer")),this.httpHandler=e.httpHandler||(defaultHttpHandler=defaultHttpHandler||require("./http-handler")),this.load(),this.localStorageObserver&&this.listenForStorageEvent()}var microee=require("microee"),defaultHttpHandler,defaultLocalStorageObserver;microee.mixin(ResourceShadow),ResourceShadow.create=function(e){return new ResourceShadow(e)},ResourceShadow.prototype.apply=function(e){var t=this.beforeApply();try{"object"==typeof e?this.mirrorObject(e,this.data):e.call(this,this.data)}finally{return this.afterApply(t),this}},ResourceShadow.prototype.beforeApply=function(){var e=this.localStorage.getItem(this.localKey);return this.mirrorObject(this.getLocalStorageValue(),this.data),e},ResourceShadow.prototype.afterApply=function(e){this.setLocalStorageValue(this.data),this.save();var t=this.localStorage.getItem(this.localKey);t!==e&&this.onChange({source:"apply"})},ResourceShadow.prototype.save=function(){if(!this.loading&&!this.saving){if(!this.online||!this.url)return void this.onSaved();var e=this.localStorage.getItem(this.localKey);if(this.shadow!==e){this.saving=!0;var t=this;this.httpHandler.put(this.url,this.httpHeaders(),e,function(o,r){return t.saving=!1,t.discardNextServerResponse?(t.discardNextServerResponse=!1,void t.emit("serverresponsediscarded")):o?void t.onSaveError(o):(t.onSaved(),void t.processJsonFromServer(r,e))})}else this.onSaved()}},ResourceShadow.prototype.loadAndRebase=function(){return this.load({})},ResourceShadow.prototype.loadLocal=function(e){var t=this.stringify(this.data);if(this.localStorage.getItem(this.localKey)!==t){var o=this.mirrorObject(this.getLocalStorageValue(),this.data);o&&(e=e||{},e.source=e.source||"localStorage",this.onChange(e))}},ResourceShadow.prototype.load=function(e){if(this.loadLocal(),this.loading||this.saving)return this;if(!this.online||!this.url)return this.onLoaded(),this;var t;e?(t=e,"string"!=typeof t&&(t=this.stringify(t))):t=this.localStorage.getItem(this.localKey),this.loading=!0;var o=this;return this.httpHandler.get(this.url,this.httpHeaders(),function(r,s){return o.loading=!1,o.discardNextServerResponse?(o.emit("serverresponsediscarded"),void(o.discardNextServerResponse=!1)):r?(r.loadArguments=[e],void o.onLoadError(r)):(o.processJsonFromServer(s,t),void o.onLoaded())}),this},ResourceShadow.prototype.processJsonFromServer=function(e,t){this.shadow=e;var o=this.localStorage.getItem(this.localKey);if(e!==t){var r=!1;if(t!==o&&(e=this.threeWayMerge(t,e,o),"object"==typeof e&&(e=this.stringify(e)),r=e!==this.shadow),e!==o){var s,a=!0;try{s=this.parse(e)}catch(i){s=null}"object"==typeof s&&(a=this.mirrorObject(s,this.data)),a&&(this.setLocalStorageValue(this.data),this.onChange({source:"server"}))}r&&this.save()}else t!==o&&this.save()},ResourceShadow.prototype.listenForStorageEvent=function(){if(!this.listeningForStorageEvent&&this.localStorageObserver){var e=this;this.localStorageObserver.onKeyChange(this.localKey,function(){this.settingLocalStorage||e.loadLocal({source:"localStorageEvent"})}),this.listeningForStorageEvent=!0}},ResourceShadow.prototype.mirrorObject=function(e,t){function o(e,t,o){var s=e[o],a=t[o];return a===s?!1:"undefined"!=typeof a&&"object"==typeof s&&"object"==typeof a&&s instanceof Array==a instanceof Array?r.mirrorObject(s,a):(t[o]=s,!0)}var r=this;if("object"!=typeof e||"object"!=typeof t)return!1;var s=!1;if(e instanceof Array&&t instanceof Array){for(var a=e.length,i=0;a>i;i++)o(e,t,i)&&(s=!0);return t.length!==e.length&&(t.length=e.length,s=!0),s}for(var n in e)o(e,t,n)&&(s=!0);for(n in t)"undefined"==typeof e[n]&&(delete t[n],s=!0);return s},ResourceShadow.prototype.threeWayMerge=function(e,t,o){return this.options.threeWayMerge?this.options.threeWayMerge.call(this,e,t,o):o},ResourceShadow.prototype.parse=function(e){return JSON.parse(e)},ResourceShadow.prototype.stringify=function(e){return JSON.stringify(e)},ResourceShadow.prototype.httpHeaders=function(){return this.options.headers},ResourceShadow.prototype.onChange=function(e){this.emit("change",this.data,e)},ResourceShadow.prototype.onSaved=function(){this.emit("saved")},ResourceShadow.prototype.onLoaded=function(){this.emit("loaded")},ResourceShadow.prototype.shouldRetry=function(e){return this.options.retry===!1?!1:e.status&&[408,409,410,419,420,429,500,502,503,504,509,521,522,524,598,599].indexOf(e.status)<0?!1:!0},ResourceShadow.prototype.onSaveError=function(e){var t=this;this.shouldRetry(e)&&setTimeout(function(){t.save()},this.options.retryDelay||5e3),this.emit("saveerror",e)},ResourceShadow.prototype.onLoadError=function(e){var t=this;this.shouldRetry(e)&&setTimeout(function(){t.load.apply(t,e.loadArguments)},this.options.retryDelay||5e3),this.emit("loaderror",e)},ResourceShadow.prototype.goOnline=function(e,t){return e&&(this.url=e),t&&(this.options.headers=t),this.online=!0,this},ResourceShadow.prototype.reset=function(e){return(this.loading||this.saving)&&(this.discardNextServerResponse=!0),this.online=!1,this.mirrorObject(e||{},this.data),this.setLocalStorageValue(this.data),this.onChange({source:"reset"}),this},ResourceShadow.prototype.getLocalStorageValue=function(){var e=this.localStorage.getItem(this.localKey);if(null===e||"undefined"==typeof e||""===e)return{};try{return this.parse(e)||{}}catch(t){return{}}},ResourceShadow.prototype.setLocalStorageValue=function(e){var t;if(null===e||"undefined"==typeof e)t=null;else try{t=this.stringify(e)}catch(o){t=null}var r=this.localStorage.getItem(this.localKey);this.settingLocalStorage=!0;try{r!==t&&(null===t?this.localStorage.removeItem(this.localKey):this.localStorage.setItem(this.localKey,t))}finally{this.settingLocalStorage=!1}return t},module.exports=ResourceShadow;
},{"./http-handler":5,"./local-storage-observer":6,"microee":3}]},{},[1])(1)
});


//# sourceMappingURL=resource-shadow.min.map