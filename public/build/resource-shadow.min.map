{"version":3,"file":"bundle.js","sources":["/source-files/resource-shadow/node_modules/fiberglass/node_modules/browserify/node_modules/browser-pack/_prelude.js","/source-files/resource-shadow/src/main.js","/source-files/resource-shadow/package.json","/source-files/resource-shadow/src/resource-shadow.js","/source-files/resource-shadow/node_modules/fiberglass/node_modules/browserify/node_modules/process/browser.js","/source-files/resource-shadow/src/local-storage-observer.js","/source-files/resource-shadow/src/http-handler.js","/source-files/resource-shadow/node_modules/microee/index.js"],"names":["ResourceShadow","options","this","data","localKey","url","localStorage","localStorageObserver","defaultLocalStorageObserver","require","httpHandler","defaultHttpHandler","load","listenForStorageEvent","microee","mixin","create","prototype","apply","changeFn","beforeApply","mirrorObject","call","afterApply","getLocalStorageValue","setLocalStorageValue","save","onChange","loading","saving","saveRequested","onSaved","json","getItem","shadow","self","put","httpHeaders","err","serverJson","onSaveError","processJsonFromServer","loadAndRebase","loadLocal","currentDataJson","stringify","preJson","onLoaded","get","loadArguments","onLoadError","newJson","saveAgain","threeWayMerge","serverData","parse","listeningForStorageEvent","onKeyChange","settingLocalStorage","source","target","copyMember","key","sourceValue","targetValue","Array","sourceLength","length","i","name","original","server","local","JSON","headers","emit","shouldRetry","retry","status","indexOf","setTimeout","retryDelay","setUrl","previousJson","removeItem","setItem","module","exports","noop","process","nextTick","canSetImmediate","window","setImmediate","canPost","postMessage","addEventListener","f","queue","ev","stopPropagation","fn","shift","push","title","browser","env","argv","on","addListener","once","off","removeListener","removeAllListeners","binding","Error","cwd","chdir","LocalStorageObserver","el","eventName","handler","attachEvent","arguments","e","HttpHandler","ajax","method","body","callback","request","XMLHttpRequest","open","setRequestHeader","header","complete","onload","responseText","onerror","send","M","_events","cb","splice","args","slice","when","c","dest","k","o","hasOwnProperty"],"mappings":"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","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","(function(e){var r=require(\"./resource-shadow\");if(exports.ResourceShadow=r,exports.create=r.create,e.browser)exports.version=\"{{package-version}}\",exports.homepage=\"{{package-homepage}}\";else{var o=require(\"../package.json\");exports.version=o.version,exports.homepage=o.homepage}}).call(this,require(\"_process\"));","module.exports={\n  \"name\": \"resource-shadow\",\n  \"version\": \"0.0.5\",\n  \"description\": \"\",\n  \"main\": \"./src/main\",\n  \"scripts\": {\n    \"test\": \"gulp test && gulp test-browser\",\n    \"bump\": \"gulp bump\",\n    \"cover\": \"istanbul cover --root src gulp test\",\n    \"cover-report\": \"open coverage/lcov-report/index.html\",\n    \"cover-publish\": \"istanbul cover _mocha --report lcovonly && codeclimate < coverage/lcov.info\"\n  },\n  \"author\": \"Benjamin Eidelman <beneidel@gmail.com>\",\n  \"homepage\": \"https://github.com/benjamine/resource-shadow\",\n  \"license\": \"MIT\",\n  \"repository\": {\n    \"type\": \"git\",\n    \"url\": \"https://github.com/benjamine/resource-shadow.git\"\n  },\n  \"devDependencies\": {\n    \"bulk-require\": \"^0.2.1\",\n    \"codeclimate-test-reporter\": \"0.0.3\",\n    \"expect.js\": \"~0.3.1\",\n    \"fiberglass\": \"~0.0.11\",\n    \"gulp\": \"^3.8.8\",\n    \"istanbul\": \"^0.3.2\",\n    \"mocha\": \"^2.0.1\"\n  },\n  \"testling\": {\n    \"harness\": \"mocha\",\n    \"files\": \"test/index.js\",\n    \"scripts\": [\n      \"build/resource-shadow.js\"\n    ],\n    \"browsers\": [\n      \"ie/8..latest\",\n      \"chrome/27..latest\",\n      \"firefox/22..latest\",\n      \"safari/5.1..latest\",\n      \"opera/12..latest\",\n      \"iphone/6..latest\",\n      \"ipad/6..latest\",\n      \"android-browser/4.2..latest\"\n    ]\n  },\n  \"dependencies\": {\n    \"microee\": \"0.0.5\"\n  }\n}\n","var microee = require('microee');\nvar defaultHttpHandler;\nvar defaultLocalStorageObserver;\n\nfunction ResourceShadow(options) {\n  this.data = {};\n  this.localKey = options.localKey;\n  this.url = options.url;\n  this.options = options;\n  this.localStorage = options.localStorage || localStorage;\n  this.localStorageObserver = options.localStorageObserver ||\n    (defaultLocalStorageObserver = defaultLocalStorageObserver || require('./local-storage-observer'));\n  this.httpHandler = options.httpHandler ||\n    (defaultHttpHandler = defaultHttpHandler || require('./http-handler'));\n  this.load();\n  if (this.localStorageObserver) {\n    this.listenForStorageEvent();\n  }\n}\n\nmicroee.mixin(ResourceShadow);\n\nResourceShadow.create = function resourceCreate(options) {\n  return new ResourceShadow(options);\n};\n\nResourceShadow.prototype.apply = function resourceChangeApply(changeFn) {\n  this.beforeApply();\n  try {\n    if (typeof changeFn === 'object') {\n      this.mirrorObject(changeFn, this.data);\n    } else {\n      changeFn.call(this, this.data);\n    }\n  } finally {\n    this.afterApply();\n    return this;\n  }\n};\n\nResourceShadow.prototype.beforeApply = function() {\n  this.mirrorObject(this.getLocalStorageValue(), this.data);\n};\n\nResourceShadow.prototype.afterApply = function() {\n  this.setLocalStorageValue(this.data);\n  this.save();\n  // TODO: call only if there are real changes\n  this.onChange();\n};\n\nResourceShadow.prototype.save = function() {\n  if (this.loading || this.saving) {\n    // changes will be detected at the end of current process\n    return;\n  }\n  this.saveRequested = false;\n  if (!this.url) {\n    // no remote url for this resource\n    this.onSaved();\n    return;\n  }\n  var json = this.localStorage.getItem(this.localKey);\n  if (this.shadow !== json) {\n    // we have changes to save\n    this.saving = true;\n    var self = this;\n    this.httpHandler.put(this.url, this.httpHeaders(), json, function(err, serverJson) {\n      self.saving = false;\n      if (err) {\n        self.onSaveError(err);\n        return;\n      }\n      self.onSaved();\n      self.processJsonFromServer(serverJson, json);\n    });\n  } else {\n    this.onSaved();\n  }\n};\n\nResourceShadow.prototype.loadAndRebase = function() {\n  // load from server, and consider all local data as most recent\n  // note: this will cause a 3-way merge\n  return this.load({});\n};\n\nResourceShadow.prototype.loadLocal = function() {\n  var currentDataJson = this.stringify(this.data);\n  if (this.localStorage.getItem(this.localKey) !== currentDataJson) {\n    this.mirrorObject(this.getLocalStorageValue(), this.data);\n    // TODO: call only if there are real changes\n    this.onChange();\n  }\n};\n\nResourceShadow.prototype.load = function(preJson) {\n\n  this.loadLocal();\n\n  if (this.loading || this.saving) {\n    // changes will be detected at the end of current process\n    return this;\n  }\n  if (!this.url) {\n    // no remote url for this resource\n    this.onLoaded();\n    return this;\n  }\n\n  var json;\n  if (preJson) {\n    json = preJson;\n    if (typeof json !== 'string') {\n      json = this.stringify(json);\n    }\n  } else {\n    json = this.localStorage.getItem(this.localKey);\n  }\n\n  this.loading = true;\n  var self = this;\n  this.httpHandler.get(this.url, this.httpHeaders(), function(err, serverJson) {\n    self.loading = false;\n    if (err) {\n      err.loadArguments = [preJson];\n      self.onLoadError(err);\n      return;\n    }\n    self.processJsonFromServer(serverJson, json);\n    self.onLoaded();\n  });\n  return this;\n};\n\nResourceShadow.prototype.processJsonFromServer = function(serverJson, preJson) {\n  this.shadow = serverJson;\n  var newJson = this.localStorage.getItem(this.localKey);\n\n  if (serverJson !== preJson) {\n    // server changes\n    var saveAgain = false;\n    if (preJson !== newJson) {\n      // conflict! both server and local changes happened\n      serverJson = this.threeWayMerge(preJson, serverJson, newJson);\n      if (typeof serverJson === 'object') {\n        serverJson = this.stringify(serverJson);\n      }\n      saveAgain = serverJson !== this.shadow;\n    }\n\n    var serverData;\n    try {\n      serverData = this.parse(serverJson);\n    } catch (err) {\n      serverData = null;\n    }\n    if (typeof serverData === 'object') {\n      this.mirrorObject(serverData, this.data);\n    }\n\n    this.setLocalStorageValue(this.data);\n    // TODO: call only if there are real changes\n    this.onChange();\n\n    if (saveAgain) {\n      this.save();\n    }\n  } else if (preJson !== newJson) {\n    // only local changes, start a new save\n    this.save();\n  }\n};\n\nResourceShadow.prototype.listenForStorageEvent = function() {\n  if (this.listeningForStorageEvent || !this.localStorageObserver) {\n    return;\n  }\n  var self = this;\n  this.localStorageObserver.onKeyChange(this.localKey, function(){\n    if (this.settingLocalStorage) {\n      return;\n    }\n    self.loadLocal();\n  });\n  this.listeningForStorageEvent = true;\n};\n\nResourceShadow.prototype.mirrorObject = function(source, target) {\n  var self = this;\n  if (typeof source !== 'object' || typeof target !== 'object') {\n    return;\n  }\n\n  function copyMember(source, target, key) {\n    var sourceValue = source[key];\n    var targetValue = target[key];\n    if (typeof targetValue !== 'undefined' &&\n      typeof sourceValue === 'object' &&\n      typeof targetValue === 'object' &&\n      (sourceValue instanceof Array) === (targetValue instanceof Array)) {\n      self.mirrorObject(sourceValue, targetValue);\n      return;\n    }\n    target[key] = sourceValue;\n  }\n\n  if (source instanceof Array && target instanceof Array) {\n    var sourceLength = source.length;\n    for (var i = 0; i < sourceLength; i++) {\n      copyMember(source, target, i);\n    }\n    target.length = source.length;\n    return;\n  }\n\n  for (var name in source) {\n    copyMember(source, target, name);\n  }\n  for (name in target) {\n    if (typeof source[name] === 'undefined') {\n      delete target[name];\n    }\n  }\n};\n\nResourceShadow.prototype.threeWayMerge = function(original, server, local) {\n  if (this.options.threeWayMerge) {\n    return this.options.threeWayMerge.call(this, original, server, local);\n  }\n  // by default, local always wins\n  return local;\n};\n\nResourceShadow.prototype.parse = function(json) {\n  return JSON.parse(json);\n};\n\nResourceShadow.prototype.stringify = function(data) {\n  return JSON.stringify(data);\n};\n\nResourceShadow.prototype.httpHeaders = function() {\n  return this.options.headers;\n};\n\nResourceShadow.prototype.onChange = function() {\n  this.emit('change', this.data);\n};\n\nResourceShadow.prototype.onSaved = function() {\n  this.emit('saved');\n};\n\nResourceShadow.prototype.onLoaded = function() {\n  this.emit('loaded');\n};\n\nResourceShadow.prototype.shouldRetry = function(err) {\n  if (this.options.retry === false) {\n    return false;\n  }\n  if (err.status &&\n    [\n      // statuses that might represent temporal failures\n      408, 409, 410, 419, 420, 429, 500, 502,\n      503, 504, 509, 521, 522, 524, 598, 599\n      ].indexOf(err.status) < 0) {\n    return false;\n  }\n  return true;\n};\n\nResourceShadow.prototype.onSaveError = function(err) {\n  var self = this;\n  if (this.shouldRetry(err)) {\n    setTimeout(function() {\n      self.save();\n    }, this.options.retryDelay || 5000);\n  }\n  this.emit('saveerror', err);\n};\n\nResourceShadow.prototype.onLoadError = function(err) {\n  var self = this;\n  if (this.shouldRetry(err)) {\n    setTimeout(function() {\n      self.load.apply(self, err.loadArguments);\n    }, this.options.retryDelay || 5000);\n  }\n  this.emit('loaderror', err);\n};\n\nResourceShadow.prototype.setUrl = function(url, headers) {\n  this.url = url;\n  if (headers) {\n    this.options.headers = headers;\n  }\n  return this;\n};\n\nResourceShadow.prototype.getLocalStorageValue = function() {\n  var json = this.localStorage.getItem(this.localKey);\n  if (json === null || typeof json === 'undefined' || json === '') {\n    return {};\n  }\n  try {\n    return this.parse(json) || {};\n  } catch (err) {\n    return {};\n  }\n};\n\nResourceShadow.prototype.setLocalStorageValue = function(data) {\n  var json;\n  if (data === null || typeof data === 'undefined') {\n    json = null;\n  } else {\n    try {\n      json = this.stringify(data);\n    } catch (err) {\n      json = null;\n    }\n  }\n  var previousJson = this.localStorage.getItem(this.localKey);\n  this.settingLocalStorage = true;\n  try {\n    if (previousJson !== json) {\n      if (json === null) {\n        this.localStorage.removeItem(this.localKey);\n      } else {\n        this.localStorage.setItem(this.localKey, json);\n      }\n    }\n  } finally {\n    this.settingLocalStorage = false;\n  }\n\n  return json;\n};\n\nmodule.exports = ResourceShadow;\n","// shim for using process in browser\n\nvar process = module.exports = {};\n\nprocess.nextTick = (function () {\n    var canSetImmediate = typeof window !== 'undefined'\n    && window.setImmediate;\n    var canPost = typeof window !== 'undefined'\n    && window.postMessage && window.addEventListener\n    ;\n\n    if (canSetImmediate) {\n        return function (f) { return window.setImmediate(f) };\n    }\n\n    if (canPost) {\n        var queue = [];\n        window.addEventListener('message', function (ev) {\n            var source = ev.source;\n            if ((source === window || source === null) && ev.data === 'process-tick') {\n                ev.stopPropagation();\n                if (queue.length > 0) {\n                    var fn = queue.shift();\n                    fn();\n                }\n            }\n        }, true);\n\n        return function nextTick(fn) {\n            queue.push(fn);\n            window.postMessage('process-tick', '*');\n        };\n    }\n\n    return function nextTick(fn) {\n        setTimeout(fn, 0);\n    };\n})();\n\nprocess.title = 'browser';\nprocess.browser = true;\nprocess.env = {};\nprocess.argv = [];\n\nfunction noop() {}\n\nprocess.on = noop;\nprocess.addListener = noop;\nprocess.once = noop;\nprocess.off = noop;\nprocess.removeListener = noop;\nprocess.removeAllListeners = noop;\nprocess.emit = noop;\n\nprocess.binding = function (name) {\n    throw new Error('process.binding is not supported');\n}\n\n// TODO(shtylman)\nprocess.cwd = function () { return '/' };\nprocess.chdir = function (dir) {\n    throw new Error('process.chdir is not supported');\n};\n","(function (process){\n\nfunction LocalStorageObserver() {\n}\n\nfunction addEventListener(el, eventName, handler) {\n  if (el.addEventListener) {\n    el.addEventListener(eventName, handler, false);\n  } else if (el.attachEvent) {\n    el.attachEvent('on' + eventName, function() {\n      handler.apply(el, arguments);\n    });\n  }\n}\n\nLocalStorageObserver.prototype.onKeyChange = function(key, handler) {\n  if (!process.browser) {\n    return;\n  }\n  addEventListener(window, 'storage', function(e) {\n    if (e.key === key) {\n      handler();\n    }\n  });\n};\n\nmodule.exports = new LocalStorageObserver();\n\n}).call(this,require('_process'))","\nfunction HttpHandler() {\n}\n\nHttpHandler.prototype.ajax = function(method, url, headers, body, callback) {\n\n  // simple browser implementation\n  var request = new XMLHttpRequest();\n  request.open(method, url, true);\n  if (body) {\n    request.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');\n  }\n  if (headers) {\n    for (var header in headers) {\n      request.setRequestHeader(header, headers[header]);\n    }\n  }\n\n  var data;\n  var complete = false;\n  request.onload = function() {\n    if (complete) {\n      return;\n    }\n    complete = true;\n    if (request.status >= 200 && request.status < 400) {\n      // Success!\n      data = request.responseText;\n      callback(null, data);\n    } else {\n      // We reached our target server, but it returned an error\n      var err = new Error('http error ' + request.status);\n      err.status = request.status;\n      callback(err);\n    }\n  };\n\n  request.onerror = function(err) {\n    // There was a connection error of some sort\n    if (complete) {\n      return;\n    }\n    complete = true;\n    callback(err);\n  };\n\n  if (body) {\n    request.send(body);\n  } else {\n    request.send();\n  }\n};\n\nHttpHandler.prototype.get = function(url, headers, callback) {\n  return this.ajax('GET', url, headers, null, callback);\n};\n\nHttpHandler.prototype.put = function(url, headers, body, callback) {\n  return this.ajax('PUT', url, headers, body, callback);\n};\n\nmodule.exports = new HttpHandler();\n","function M() { this._events = {}; }\nM.prototype = {\n  on: function(ev, cb) {\n    this._events || (this._events = {});\n    var e = this._events;\n    (e[ev] || (e[ev] = [])).push(cb);\n    return this;\n  },\n  removeListener: function(ev, cb) {\n    var e = this._events[ev] || [], i;\n    for(i = e.length-1; i >= 0 && e[i]; i--){\n      if(e[i] === cb || e[i].cb === cb) { e.splice(i, 1); }\n    }\n  },\n  removeAllListeners: function(ev) {\n    if(!ev) { this._events = {}; }\n    else { this._events[ev] && (this._events[ev] = []); }\n  },\n  emit: function(ev) {\n    this._events || (this._events = {});\n    var args = Array.prototype.slice.call(arguments, 1), i, e = this._events[ev] || [];\n    for(i = e.length-1; i >= 0 && e[i]; i--){\n      e[i].apply(this, args);\n    }\n    return this;\n  },\n  when: function(ev, cb) {\n    return this.once(ev, cb, true);\n  },\n  once: function(ev, cb, when) {\n    if(!cb) return this;\n    function c() {\n      if(!when) this.removeListener(ev, c);\n      if(cb.apply(this, arguments) && when) this.removeListener(ev, c);\n    }\n    c.cb = cb;\n    this.on(ev, c);\n    return this;\n  }\n};\nM.mixin = function(dest) {\n  var o = M.prototype, k;\n  for (k in o) {\n    o.hasOwnProperty(k) && (dest.prototype[k] = o[k]);\n  }\n};\nmodule.exports = M;\n"]}