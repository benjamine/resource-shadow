{"version":3,"file":"bundle.js","sources":["/source-files/resource-shadow/node_modules/fiberglass/node_modules/browserify/node_modules/browser-pack/_prelude.js","/source-files/resource-shadow/src/main.js","/source-files/resource-shadow/package.json","/source-files/resource-shadow/src/resource-shadow.js","/source-files/resource-shadow/node_modules/fiberglass/node_modules/browserify/node_modules/process/browser.js","/source-files/resource-shadow/src/http-handler.js","/source-files/resource-shadow/node_modules/microee/index.js"],"names":["process","ResourceShadow","options","this","localKey","url","localStorage","httpHandler","defaultHttpHandler","require","load","listenForStorageEvent","microee","mixin","create","prototype","apply","changeFn","data","beforeApply","afterApply","getLocalStorageValue","setLocalStorageValue","save","onChange","loading","saving","saveRequested","onSaved","json","getItem","shadow","self","put","httpHeaders","err","serverJson","onSaveError","processJsonFromServer","loadAndRebase","preJson","currentDataJson","stringify","onLoaded","get","loadArguments","onLoadError","newJson","saveAgain","threeWayMerge","parse","addEventListener","el","eventName","handler","attachEvent","arguments","listeningForStorageEvent","browser","e","key","window","original","server","local","call","JSON","headers","emit","shouldRetry","retry","status","indexOf","setTimeout","retryDelay","setUrl","previousJson","removeItem","setItem","module","exports","noop","nextTick","canSetImmediate","setImmediate","canPost","postMessage","f","queue","ev","source","stopPropagation","length","fn","shift","push","title","env","argv","on","addListener","once","off","removeListener","removeAllListeners","binding","Error","cwd","chdir","HttpHandler","ajax","method","body","callback","request","XMLHttpRequest","open","setRequestHeader","header","complete","onload","responseText","onerror","send","M","_events","cb","i","splice","args","Array","slice","when","c","dest","k","o","hasOwnProperty"],"mappings":"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","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","(function(e){var r=require(\"./resource-shadow\");if(exports.ResourceShadow=r,exports.create=r.create,e.browser)exports.version=\"{{package-version}}\",exports.homepage=\"{{package-homepage}}\";else{var o=require(\"../package.json\");exports.version=o.version,exports.homepage=o.homepage}}).call(this,require(\"_process\"));","module.exports={\n  \"name\": \"resource-shadow\",\n  \"version\": \"0.0.1\",\n  \"description\": \"\",\n  \"main\": \"./src/main\",\n  \"scripts\": {\n    \"test\": \"gulp test && gulp test-browser\",\n    \"bump\": \"gulp bump\",\n    \"cover\": \"istanbul cover --root src gulp test\",\n    \"cover-report\": \"open coverage/lcov-report/index.html\",\n    \"cover-publish\": \"istanbul cover _mocha --report lcovonly && codeclimate < coverage/lcov.info\"\n  },\n  \"author\": \"Benjamin Eidelman <beneidel@gmail.com>\",\n  \"license\": \"MIT\",\n  \"repository\": {\n    \"type\": \"git\",\n    \"url\": \"https://github.com/benjamine/resource-shadow.git\"\n  },\n  \"devDependencies\": {\n    \"bulk-require\": \"^0.2.1\",\n    \"codeclimate-test-reporter\": \"0.0.3\",\n    \"expect.js\": \"~0.3.1\",\n    \"fiberglass\": \"~0.0.11\",\n    \"gulp\": \"^3.8.8\",\n    \"istanbul\": \"^0.3.2\",\n    \"mocha\": \"^2.0.1\"\n  },\n  \"testling\": {\n    \"harness\": \"mocha\",\n    \"files\": \"test/index.js\",\n    \"scripts\": [\n      \"build/resource-shadow.js\"\n    ],\n    \"browsers\": [\n      \"ie/8..latest\",\n      \"chrome/27..latest\",\n      \"firefox/22..latest\",\n      \"safari/5.1..latest\",\n      \"opera/12..latest\",\n      \"iphone/6..latest\",\n      \"ipad/6..latest\",\n      \"android-browser/4.2..latest\"\n    ]\n  },\n  \"dependencies\": {\n    \"microee\": \"0.0.5\"\n  }\n}\n","(function (process){\nvar microee = require('microee');\nvar defaultHttpHandler;\n\nfunction ResourceShadow(options) {\n  this.localKey = options.localKey;\n  this.url = options.url;\n  this.options = options;\n  this.localStorage = options.localStorage || localStorage;\n  this.httpHandler = options.httpHandler ||\n    (defaultHttpHandler = defaultHttpHandler || require('./http-handler'));\n  this.load();\n  this.listenForStorageEvent();\n}\n\nmicroee.mixin(ResourceShadow);\n\nResourceShadow.create = function resourceCreate(options) {\n  return new ResourceShadow(options);\n};\n\nResourceShadow.prototype.apply = function resourceChangeApply(changeFn) {\n  var data = this.beforeApply();\n  try {\n    data = changeFn(data) || data;\n  } finally {\n    this.afterApply(data);\n    return this;\n  }\n};\n\nResourceShadow.prototype.beforeApply = function() {\n  return this.getLocalStorageValue();\n};\n\nResourceShadow.prototype.afterApply = function(data) {\n  this.setLocalStorageValue(data);\n  this.data = data;\n  this.save();\n  this.onChange();\n};\n\nResourceShadow.prototype.save = function() {\n  if (this.loading || this.saving) {\n    // changes will be detected at the end of current process\n    return;\n  }\n  this.saveRequested = false;\n  if (!this.url) {\n    // no remote url for this resource\n    this.onSaved();\n    return;\n  }\n  var json = this.localStorage.getItem(this.localKey);\n  if (this.shadow !== json) {\n    // we have changes to save\n    this.saving = true;\n    var self = this;\n    this.httpHandler.put(this.url, this.httpHeaders(), json, function(err, serverJson) {\n      self.saving = false;\n      if (err) {\n        self.onSaveError(err);\n        return;\n      }\n      self.onSaved();\n      self.processJsonFromServer(serverJson, json);\n    });\n  } else {\n    this.onSaved();\n  }\n};\n\nResourceShadow.prototype.loadAndRebase = function() {\n  // load from server, and consider all local data as most recent\n  // note: this will cause a 3-way merge\n  return this.load({});\n};\n\nResourceShadow.prototype.load = function(preJson) {\n\n  var currentDataJson = this.stringify(this.data);\n  if (this.localStorage.getItem(this.localKey) !== currentDataJson) {\n    this.data = this.getLocalStorageValue();\n    this.onChange();\n  }\n\n  if (this.loading || this.saving) {\n    // changes will be detected at the end of current process\n    return this;\n  }\n  if (!this.url) {\n    // no remote url for this resource\n    this.onLoaded();\n    return this;\n  }\n\n  var json;\n  if (preJson) {\n    json = preJson;\n    if (typeof json !== 'string') {\n      json = this.stringify(json);\n    }\n  } else {\n    json = this.localStorage.getItem(this.localKey);\n  }\n\n  this.loading = true;\n  var self = this;\n  this.httpHandler.get(this.url, this.httpHeaders(), function(err, serverJson) {\n    self.loading = false;\n    if (err) {\n      err.loadArguments = [preJson];\n      self.onLoadError(err);\n      return;\n    }\n    self.processJsonFromServer(serverJson, json);\n    self.onLoaded();\n  });\n  return this;\n};\n\nResourceShadow.prototype.processJsonFromServer = function(serverJson, preJson) {\n  this.shadow = serverJson;\n  var newJson = this.localStorage.getItem(this.localKey);\n\n  if (serverJson !== preJson) {\n    // server changes\n    var saveAgain = false;\n    if (preJson !== newJson) {\n      // conflict! both server and local changes happened\n      serverJson = this.threeWayMerge(preJson, serverJson, newJson);\n      if (typeof serverJson === 'object') {\n        serverJson = this.stringify(serverJson);\n      }\n      saveAgain = serverJson !== this.shadow;\n    }\n\n    try  {\n      this.data = this.parse(serverJson);\n    } catch (err) {\n      this.data = null;\n    }\n    this.setLocalStorageValue(this.data);\n    this.onChange();\n\n    if (saveAgain) {\n      this.save();\n    }\n  } else if (preJson !== newJson) {\n    // only local changes, start a new save\n    this.save();\n  }\n};\n\nResourceShadow.prototype.listenForStorageEvent = function() {\n  if (this.listeningForStorageEvent) {\n    return;\n  }\n\n  if (!process.browser) {\n    return;\n  }\n\n  function addEventListener(el, eventName, handler) {\n    if (el.addEventListener) {\n      el.addEventListener(eventName, handler, false);\n    } else if (el.attachEvent) {\n      el.attachEvent('on' + eventName, function(){\n        handler.apply(el, arguments);\n      });\n    }\n  }\n\n  var self = this;\n  var handler = function(e) {\n    if (e.key === self.localKey) {\n      self.load();\n    }\n  };\n\n  addEventListener(window, 'storage', handler);\n  this.listeningForStorageEvent = true;\n};\n\nResourceShadow.prototype.threeWayMerge = function(original, server, local) {\n  if (this.options.threeWayMerge) {\n    return this.options.threeWayMerge.call(this, original, server, local);\n  }\n  // by default, local always wins\n  return local;\n};\n\nResourceShadow.prototype.parse = function(json) {\n  return JSON.parse(json);\n};\n\nResourceShadow.prototype.stringify = function(data) {\n  return JSON.stringify(data);\n};\n\nResourceShadow.prototype.httpHeaders = function() {\n  return this.options.headers;\n};\n\nResourceShadow.prototype.onChange = function() {\n  this.emit('change', this.data);\n};\n\nResourceShadow.prototype.onSaved = function() {\n  this.emit('saved');\n};\n\nResourceShadow.prototype.onLoaded = function() {\n  this.emit('loaded');\n};\n\nResourceShadow.prototype.shouldRetry = function(err) {\n  if (this.options.retry === false) {\n    return false;\n  }\n  if (err.status &&\n    [\n      // statuses that might represent temporal failures\n      408, 409, 410, 419, 420, 429, 500, 502,\n      503, 504, 509, 521, 522, 524, 598, 599\n      ].indexOf(err.status) < 0) {\n    return false;\n  }\n  return true;\n};\n\nResourceShadow.prototype.onSaveError = function(err) {\n  var self = this;\n  if (this.shouldRetry(err)) {\n    setTimeout(function() {\n      self.save();\n    }, this.options.retryDelay || 5000);\n  }\n  this.emit('saveerror', err);\n};\n\nResourceShadow.prototype.onLoadError = function(err) {\n  var self = this;\n  if (this.shouldRetry(err)) {\n    setTimeout(function() {\n      self.load.apply(self, err.loadArguments);\n    }, this.options.retryDelay || 5000);\n  }\n  this.emit('loaderror', err);\n};\n\nResourceShadow.prototype.setUrl = function(url, headers) {\n  this.url = url;\n  if (headers) {\n    this.options.headers = headers;\n  }\n  return this;\n};\n\nResourceShadow.prototype.getLocalStorageValue = function() {\n  var json = this.localStorage.getItem(this.localKey);\n  if (json === null || typeof json === 'undefined' || json === '') {\n    return null;\n  }\n  try {\n    return this.parse(json);\n  } catch (err) {\n    return null;\n  }\n};\n\nResourceShadow.prototype.setLocalStorageValue = function(data) {\n  var json;\n  if (data === null || typeof data === 'undefined') {\n    json = null;\n  } else {\n    try {\n      json = this.stringify(data);\n    } catch (err) {\n      json = null;\n    }\n  }\n  var previousJson = this.localStorage.getItem(this.localKey);\n  if (previousJson !== json) {\n    if (json === null) {\n      this.localStorage.removeItem(this.localKey);\n    } else {\n      this.localStorage.setItem(this.localKey, json);\n    }\n  }\n\n  return json;\n};\n\nmodule.exports = ResourceShadow;\n\n}).call(this,require('_process'))","// shim for using process in browser\n\nvar process = module.exports = {};\n\nprocess.nextTick = (function () {\n    var canSetImmediate = typeof window !== 'undefined'\n    && window.setImmediate;\n    var canPost = typeof window !== 'undefined'\n    && window.postMessage && window.addEventListener\n    ;\n\n    if (canSetImmediate) {\n        return function (f) { return window.setImmediate(f) };\n    }\n\n    if (canPost) {\n        var queue = [];\n        window.addEventListener('message', function (ev) {\n            var source = ev.source;\n            if ((source === window || source === null) && ev.data === 'process-tick') {\n                ev.stopPropagation();\n                if (queue.length > 0) {\n                    var fn = queue.shift();\n                    fn();\n                }\n            }\n        }, true);\n\n        return function nextTick(fn) {\n            queue.push(fn);\n            window.postMessage('process-tick', '*');\n        };\n    }\n\n    return function nextTick(fn) {\n        setTimeout(fn, 0);\n    };\n})();\n\nprocess.title = 'browser';\nprocess.browser = true;\nprocess.env = {};\nprocess.argv = [];\n\nfunction noop() {}\n\nprocess.on = noop;\nprocess.addListener = noop;\nprocess.once = noop;\nprocess.off = noop;\nprocess.removeListener = noop;\nprocess.removeAllListeners = noop;\nprocess.emit = noop;\n\nprocess.binding = function (name) {\n    throw new Error('process.binding is not supported');\n}\n\n// TODO(shtylman)\nprocess.cwd = function () { return '/' };\nprocess.chdir = function (dir) {\n    throw new Error('process.chdir is not supported');\n};\n","\nfunction HttpHandler() {\n}\n\nHttpHandler.prototype.ajax = function(method, url, headers, body, callback) {\n\n  // simple browser implementation\n  var request = new XMLHttpRequest();\n  request.open(method, url, true);\n  if (body) {\n    request.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');\n  }\n  if (headers) {\n    for (var header in headers) {\n      request.setRequestHeader(header, headers[header]);\n    }\n  }\n\n  var data;\n  var complete = false;\n  request.onload = function() {\n    if (complete) {\n      return;\n    }\n    complete = true;\n    if (request.status >= 200 && request.status < 400) {\n      // Success!\n      data = request.responseText;\n      callback(null, data);\n    } else {\n      // We reached our target server, but it returned an error\n      var err = new Error('http error ' + request.status);\n      err.status = request.status;\n      callback(err);\n    }\n  };\n\n  request.onerror = function(err) {\n    // There was a connection error of some sort\n    if (complete) {\n      return;\n    }\n    complete = true;\n    callback(err);\n  };\n\n  if (body) {\n    request.send(body);\n  } else {\n    request.send();\n  }\n};\n\nHttpHandler.prototype.get = function(url, headers, callback) {\n  return this.ajax('GET', url, headers, null, callback);\n};\n\nHttpHandler.prototype.put = function(url, headers, body, callback) {\n  return this.ajax('PUT', url, headers, body, callback);\n};\n\nmodule.exports = new HttpHandler();\n","function M() { this._events = {}; }\nM.prototype = {\n  on: function(ev, cb) {\n    this._events || (this._events = {});\n    var e = this._events;\n    (e[ev] || (e[ev] = [])).push(cb);\n    return this;\n  },\n  removeListener: function(ev, cb) {\n    var e = this._events[ev] || [], i;\n    for(i = e.length-1; i >= 0 && e[i]; i--){\n      if(e[i] === cb || e[i].cb === cb) { e.splice(i, 1); }\n    }\n  },\n  removeAllListeners: function(ev) {\n    if(!ev) { this._events = {}; }\n    else { this._events[ev] && (this._events[ev] = []); }\n  },\n  emit: function(ev) {\n    this._events || (this._events = {});\n    var args = Array.prototype.slice.call(arguments, 1), i, e = this._events[ev] || [];\n    for(i = e.length-1; i >= 0 && e[i]; i--){\n      e[i].apply(this, args);\n    }\n    return this;\n  },\n  when: function(ev, cb) {\n    return this.once(ev, cb, true);\n  },\n  once: function(ev, cb, when) {\n    if(!cb) return this;\n    function c() {\n      if(!when) this.removeListener(ev, c);\n      if(cb.apply(this, arguments) && when) this.removeListener(ev, c);\n    }\n    c.cb = cb;\n    this.on(ev, c);\n    return this;\n  }\n};\nM.mixin = function(dest) {\n  var o = M.prototype, k;\n  for (k in o) {\n    o.hasOwnProperty(k) && (dest.prototype[k] = o[k]);\n  }\n};\nmodule.exports = M;\n"]}